<link href="../coupons.css" rel="stylesheet">
<div id="wrapper" class="main_container">

        <div id="grid" class="row">
        
            <div id="coupon_container" class="coupons_container">
                    <script id="coupon_template" type="x-tmpl-mustache/text">
                       <div class="col-md-6">
                            <div class="product large" id="{{id}}" style="height:100%; background:#fafafa;">
                              
                                <div class="info-large col-md-12">
                                    <img src="{{promo_image_url_abs}}" alt="" style="height:100%" />
                            	    <p>{{store_name}}</p>
                                	<h4>{{name}}</h4>
                                	<p>{{dates}}</p>
                                    
                                    <p>{{{description}}}</p>                          
                                                 
                                </div>
                            </div> 
                        </div>
                    </script>
            </div>
    </div>
</div>
<script>

    var selected_coupon_id = [];
    
    $(document).ready(function(e){
        init(e);
        loadMallDataCached(renderAll);
    });
    function renderAll(){
        // var stores = getStoresList();
        // renderStoreList('#store_list_container','#store_list_template', stores, "stores", "#", "Z");
        // $('#store_list_container').prepend('<li href="#" class="show_all_stores  padding_5 uppercase">All</li>');
        // var categories = getStoreCategories();
        // // console.log(category_of_stores);
        // renderGeneral('#category_container, #category_container2', '#category_template', category_of_stores);
        // $('#category_container, #category_container2').prepend('<li href="#" class="show_all_stores">All</li>');
        
       
        
        // var cache_coupon_ids = localStorage['coupon_ids'];
        var cache_coupon_ids = $.cookie().coupon_ids;
        if (cache_coupon_ids) {
            selected_coupon_id = JSON.parse(cache_coupon_ids);
            console.log(selected_coupon_id);
            var coupons = [];
            // console.log(coupons);
            all_coupons = getCouponsList();
            
            $.each(all_coupons , function (index, val){
                var is_inArray = $.grep(Object.keys(selected_coupon_id), function(i) {
                    // console.log(value);
                    return val.id.toString() ==selected_coupon_id[i];
                });
                if(is_inArray.length > 0){
                    coupons.push(val);
                }
            });
            renderCoupons('#coupon_container','#coupon_template', coupons);
            // updatePage();
        }
            
            
            
    // 	$(".largeGrid").click(function(){											
    //         $(this).find('a').addClass('active');
    //         $('.smallGrid a').removeClass('active');
            
    //         $('.product').addClass('large').each(function(){											
    //     		});						
    // 		setTimeout(function(){
    // 			$('.info-large').show();	
    // 		}, 200);
    // 		setTimeout(function(){
    
    // 			$('.view_gallery').trigger("click");	
    // 		}, 400);								
    		
    // 		return false;				
    // 	});
    	
    // 	$(".smallGrid").click(function(){		        
    //     $(this).find('a').addClass('active');
    //     $('.largeGrid a').removeClass('active');
        
    // 		$('div.product').removeClass('large');
    // 		$(".make3D").removeClass('animate');	
    //     $('.info-large').fadeOut("fast");
    // 		setTimeout(function(){								
    // 				$('div.flip-back').trigger("click");
    // 		}, 400);
    // 		return false;
    // 	});		
    	
    // 	$(".smallGrid").click(function(){
    // 		$('.product').removeClass('large');			
    // 		return false;
    // 	});
      
    //     $('.colors-large a').click(function(){return false;});
        
    //     // $(".print_btn").click(function(e){
    //         // printPage();
    //     // });
    // 	$('.add-to-basket').each(function(i, el){
    // 	   // console.log("baskets", $(el));
    // 		$(el).click(function(){
    // 		  //  console.log("clicked", $(el));
    // 		    var current_coupon_id = $(el).parent().parent().attr("id");
    // 		    console.log(current_coupon_id);
    		  
    // 		    $(".basket_number").text(parseInt($(".basket_number").text())-1);
    // 		        $("#"+current_coupon_id).parent().hide();
    // 		        //remove coupon from list variable
    // 		        selected_coupon_id = $.grep(selected_coupon_id, function( val, i ) {
    //                     return (val !== current_coupon_id);
    //                 });
    // 		    //getting the logo image
    // 		  //  console.log($("#"+$(el).parent().parent().attr("id") +" .product-front"));
    		    
    // 			//add updated coupon list to localstorage
    // // 			localStorage['coupon_ids'] = JSON.stringify(selected_coupon_id);
    // // 			console.log(localStorage['coupon_ids']);
    //             $.cookie("coupon_ids",JSON.stringify(selected_coupon_id)); 
			 //      console.log($.cookie("coupon_ids"));
    // 		});
    // 	})

        // function updatePage (){
        //     // selected_coupon_id;
        //      $(".basket_number").text(Object.keys(selected_coupon_id).length);
        //     // $.each(selected_coupon_id, function(key,val){ 
        //     //     $("#" +val + " .add-to-basket").attr("is_in_cart","true");
    	   //    // $("#" +val + " .add-to-basket").attr("src","//codecloud.cdn.speedyrails.net/sites/59d7b1c56e6f64669e8d0000/image/png/1508347595000/CheckmarkGreen.png");
    	   //    // $("#"+val).addClass("green_selected_box"); 
        //     // })
            
        // }
    
        
        $('.custom_backdrop').remove();
        $('.yield').fadeIn();
    }
    
    function renderCoupons(container, template, collection){
        var item_list = [];
        var item_rendered = [];
        var template_html = $(template).html();
        Mustache.parse(template_html); 
        $.each( collection , function( key, val ) {
            if (val.promotionable_type == "Store") {
                var store_details = getStoreDetailsByID(val.promotionable_id);
                val.store_detail_btn = store_details.slug ;
                val.store_name = store_details.name;
            }
            else {
                val.store_name = site_json.name;
            }
            if (val.promo_image_url_abs.indexOf('missing.png') > 0){
                val.promo_image_url_abs  = site_json.default_image ;
                // val.promo_image = "display:none";
                // val.full_width = "width:100%"
            }
            if (val.description.length > 200){
                val.description_short = val.description.substring(0, 200) + "..."
            }
            else {
                val.description_short = val.description
            }
            // var show_date = new Date (val.show_on_web_date + site_json.time_zone);
            // start = new Date (val.start_date + site_json.time_zone);
            // end = new Date (val.end_date + site_json.time_zone);
            // if (start.toDateString() == end.toDateString()) {
            //     val.dates = (get_month(start.getMonth()))+" "+(start.getDate());    
            // } else {
            //     val.dates = "Starts " + (get_month(start.getMonth()))+" "+(start.getDate())+" - Ends "+get_month(end.getMonth())+" "+end.getDate();    
            // }
            
            var show_date = moment(val.show_on_web_date).tz(getPropertyTimeZone());
            var start = moment(val.start_date).tz(getPropertyTimeZone());
            var end = moment(val.end_date).tz(getPropertyTimeZone());
            if (start.format("DMY") == end.format("DMY")){
            	val.dates = start.format("MMM D");
            }
            else {
            	val.dates = start.format("MMM D") + " - " + end.format("MMM D");
            }
            var rendered = Mustache.render(template_html,val);
            item_rendered.push(rendered);
        });
        $(container).html(item_rendered.join(''));
    }
    

</script>